"0","prog_type <- fins |> "
"0","  group_by(year, program) |> "
"0","  summarize("
"0","    Targeted = sum(targeted, na.rm = TRUE),"
"0","    Ongoing = sum(ongoing, na.rm = TRUE),"
"0","    `One Time` = sum(one_time, na.rm = TRUE)"
"0","  )"
"1","[38;5;233m`summarise()` has grouped output by 'year'. You can override using the `.groups` argument.[39m
"
"0","# Reshape data to long format for plotting"
"0","prog_type <- prog_type %>%"
"0","  pivot_longer("
"0","    cols = c(Ongoing, ""One Time"", Targeted),"
"0","    names_to = ""type"","
"0","    values_to = ""amount"""
"0","  ) %>%"
"0","  group_by(program, type) |>"
"0","  arrange(year) |>"
"0","  mutate(value_2020 = first(amount),"
"0","         change_from_2020 = amount - value_2020,"
"0","         pct_change =  (change_from_2020 / value_2020) * 100,"
"0","        "
"0","        tooltip = paste0(""Program: "", program, ""<br>"","
"0","                     ""Funding Type: "", type, ""<br>"","
"0","                     ""Funding Change from 2020: "", scales::comma(change_from_2020), ""<br>"","
"0","                     ""Percent Change: "", pct_change, ""<br>"","
"0","                     ""Total Funding (2023): "", scales::comma(amount))) |>"
"0","  ungroup() |>"
"0","  filter(year > 2020)"
"0","         "
"0",""
"0",""
"0",""
"0","# Calculate the total unit change by program"
"0","total_change_prog <- prog_type %>%"
"0","  group_by(program, year) %>%"
"0","  arrange(year) |>"
"0","  mutate(label_placement = ifelse(change_from_2020 < 0, 0, change_from_2020), "
"0","         label_placement = sum(label_placement)) |>"
"0","  summarize(amount = sum(amount, na.rm = TRUE),"
"0","            change_from_2020 = sum(change_from_2020, na.rm = TRUE),"
"0","            value_2020 = sum(value_2020, na.rm = T),"
"0","            label_placement = first(label_placement)) |>"
"0","  ungroup() |>"
"0","  mutate(   pct_change = change_from_2020 / value_2020 * 100,"
"0","            label_text = paste0("
"0","                      ifelse(change_from_2020 >= 0, ""+"", """"), "
"0","                              scales::comma(round(change_from_2020/1000,0)),"
"0","                      "" ("", scales::percent(pct_change / 100, accuracy = 0.1), "")"")) |>"
"0","  ungroup()"
"1","[38;5;233m`summarise()` has grouped output by 'program'. You can override using the `.groups` argument.[39m
"
"0","# Reorder programs by total unit change"
"0","plot_summary <- prog_type %>%"
"0","  left_join(total_change_prog |> select(year, program, label_text, label_placement, change_from_2020), by = c(""year"", ""program"")) %>%"
"0","  mutate(program = forcats::fct_reorder(program, -change_from_2020.y)) |>"
"0","  ungroup()"
"0",""
"0","# Plot with reordered programs and labels"
"0","p1 <- plot_summary |> ggplot(aes(x = factor(year), y = change_from_2020.x, fill = type)) +"
"0","  geom_col_interactive("
"0","     position = position_stack(reverse = FALSE),"
"0","    aes(tooltip = tooltip)"
"0","  ) +"
"0","  # Interactive labels"
"0","  geom_text_interactive("
"0","    data = plot_summary,"
"0","    aes("
"0","      x = factor(year), "
"0","      y = change_from_2020.x,"
"0","      label = """","
"0","      tooltip = tooltip"
"0","    ),"
"0","    vjust = -0.7,"
"0","    size = lab_size,"
"0","    inherit.aes = FALSE"
"0","  ) +"
"0","  labs("
"0","    title = ""Yearly Change in Funding by Program and Unit Type (Thousands $)"","
"0","    x = element_blank(),"
"0","    y = ""Funding - Previous Years' Funding\n(Thousands $)"","
"0","    fill = ""Funding Type"""
"0","  ) +"
"0","  custom_theme(add_size = -12, base_theme = theme_bw()) +"
"0","  scale_fill_brewer(palette = ""Set2"", direction = 1) +"
"0","  scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0.05, 0.22))) +"
"0","  theme("
"0","    #axis.text.x = element_text(angle = 45, hjust = 1, size = 14),"
"0","    #plot.title = element_text(hjust = 0.5, size = 16),"
"0","    legend.position = ""right"","
"0","      axis.title.x = element_blank(),"
"0",""
"0","      axis.text.x = element_text(face = ""plain"",size = 12, lineheight = 0.9),"
"0","      axis.text.y = element_blank(),"
"0","      #axis.ticks.x = element_line(colour = gray_colour, linewidth = 0.25),"
"0","     axis.ticks.y = element_blank(),"
"0","      #axis.ticks.length = unit(0, ""mm""),"
"0","      #axis.line.x = element_line(linewidth = 0.25, colour = gray_colour), "
"0","      #text = element_text(colour = font_colour),"
"0","    # axis.title.x = element_blank(),"
"0","    #legend.text = element_text(size=21+ add_size),"
"0","    #legend.title = element_text(size=23+ add_size, face = ""bold""),"
"0","   # plot.caption = ggtext::element_markdown(size = 14+ add_size, hjust = 0, color = ""grey50"", margin = margin(t = 10, l = 5)),"
"0","         #strip.text = element_text(size = 24+ add_size)"
"0","  ) +"
"0","  geom_hline(yintercept = 0, color = ""black"", size = 0.5) +"
"0","  # Add labels for total unit change above each bar"
"0","  geom_text("
"0","    data = total_change_prog,"
"0","    aes(x = factor(year), vjust = -0.5, y = label_placement,"
"0","        label = label_text),"
"0","    inherit.aes = FALSE, color = ""black"", size = 4"
"0","  ) +"
"0","  facet_wrap(~program, ncol = 3, scales = ""fixed"") "
"0","  #scale_y_continuous(scales::comma())"
"0",""
"0","p1 <- girafe(ggobj = p1, options = list(opts_zoom(min = 0.21, max = 10))) # Adjust min and max zoom levels"
"0",""
"0",""
"0","combined <- tagList("
"0","  tags$div("
"0","    style = ""display: flex; justify-content: space-between; align-items: center; margin-bottom: -5px;"", # Reduced bottom margin"
"0","    tags$div(style = ""flex: 1; margin-right: 10px;"", p1)"
"0","  ),"
"0","  tags$p("
"0","    style = ""text-align: left; margin-top: -5px; font-style: italic; color: #989898;"", # Negative margin to reduce spacing"
"0","    ""Note: this plot is interactive. Look at the icons on the top right of each plot to enable different interactive actions, such as scrolling in or zooming. Hover over the bars to see more details about the funding amounts and programs."""
"0","  )"
"0",")"
"0",""
"0","# Save or display"
"0","browsable(combined)"
