"0",""
"0","# Assuming the `unit_summary` tibble is created as follows:"
"0","fund_summary <- fin_programs |>"
"0","  group_by(program) |>"
"0","  arrange(year) |>"
"0","  mutate(total = total / 1e6,"
"0","         funds_2020 = ifelse(any(year == 2020), first(total), NA),"
"0","         `fund Change from 2020` = round(total - funds_2020,2),"
"0","         pct_change =  (`fund Change from 2020`) / funds_2020 * 100,"
"0","         label_text = paste0("
"0","                      ifelse(`fund Change from 2020` >= 0, ""+$"", ""$""), "
"0","                              scales::comma(`fund Change from 2020`),"
"0","                      "" ("", scales::percent(pct_change / 100, accuracy = 0.1), "")"""
"0","    )) |>"
"0","  ungroup() |>"
"0","  mutate("
"0","    label_text =  label_text)"
"0",""
"0",""
"0","# Find the maximum absolute value for each Program"
"0","program_max <- fund_summary %>%"
"0","  group_by(program) %>%"
"0","  summarize(max_change = max(abs(`fund Change from 2020`), na.rm = TRUE))"
"0",""
"0",""
"0","fund_summary <- fund_summary %>%"
"0","  left_join(program_max, by = ""program"") %>%"
"0","  mutate("
"0","    # Nudge: 5% of max, but minimum 100 funds"
"0","    label_nudge = pmax(0.05 * max_change, 100),"
"0","    label_position = ifelse(`fund Change from 2020` >= 0,"
"0","                             `fund Change from 2020` + label_nudge,"
"0","                             `fund Change from 2020` - label_nudge),"
"0","    vjust = ifelse(`fund Change from 2020` >= 0, -0.5, 1.5),"
"0","  )"
"0",""
"0",""
"0","fund_summary <- fund_summary %>%"
"0","  #mutate( `Unit Change from 2020` = ifelse(grepl(""Agreement"", Program), `Total Units` - 0, `Total Units` - first(`Total Units`))) |>"
"0","  filter(year != 2020)"
"0",""
"0",""
"0",""
"0","ggplot(fund_summary, aes(x = factor(year), y = `fund Change from 2020`, fill = program)) +"
"0","  geom_bar(stat = ""identity"") +"
"0","  geom_text("
"0","    aes("
"0","      y = `fund Change from 2020`,"
"0","      label = label_text,"
"0","       vjust = vjust"
"0","    ),"
"0","    size = 8"
"0","  ) +"
"0","   scale_y_continuous(labels = scales::dollar, expand = expansion(mult = c(0.25, 0.25))) +"
"0","  #scale_fill_brewer(palette = ""Set2"", direction = 1) +"
"0","  guides(fill = guide_legend(reverse = TRUE)) +"
"0","  labs("
"0","    title = ""Change in Annual Operating Subsidy Amount from 2020 (Million $)"","
"0","    x = NULL,"
"0","    y = ""Amount (Million $)"","
"0","    fill = NULL"
"0","  ) +"
"0","  #custom_theme(add_size = -12, base_theme = theme_bw()) +"
"0","  geom_hline(yintercept = 0, color = ""black"", size = 1) +"
"0","  theme_bw() +"
"0","  theme("
"0","    element_text(size = 24),  # Increase all text elements uniformly"
"0","    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 22),"
"0","    plot.margin = margin(8, 8, 0, 8),"
"0","      plot.title = element_text(size = 30 + add_size, lineheight = 0.9, face = ""bold"", margin = margin(0, 0, 6, 0)),"
"0","      plot.title.position = ""plot"","
"0","    strip.text = element_text(size = 24),"
"0","    axis.text.y = element_blank(),"
"0","    axis.title.y = element_text(size = 28),"
"0","    axis.ticks = element_blank(),"
"0","    legend.position = ""none"""
"0","  ) +"
"0","  facet_wrap(~program, scales = ""free_y"")"
